import os
import sys
import re
#该函数用来提取清单及清单中的权限，传入参数为apk的绝对路径
def test(apkpath):
    #执行aapt命令提取清单
    output = os.popen("aapt dump permissions %s" % apkpath).read()
    #获得所有的权限
    outList = output.split('\n')
    list0 = []
    cop = re.compile("[^a-z^A-Z^0-9^\.^\_]")
    for line in outList:
        if line.startswith('uses-permission:'):
            line = line.split('=')[1]
            str = cop.sub("", line)
            list0.append(str)
    dir_path = os.path.dirname(os.path.abspath('__file__'))#使用绝对路径引用
    evaltxt = open(dir_path + "/evalnew.txt", 'r')
    normaltxt = open(dir_path + "/normalnew.txt", 'r')
    egraph = eval(evaltxt.read())
    ngraph = eval(normaltxt.read())
    evaltxt.close()
    normaltxt.close()
    score_1 = 0
    score_2 = 0
    evpermissiondic = {}
    k = 0
    for i in range(len(list0) - 1):
        for j in range(i + 1, len(list0)):
            if (list0[i], list0[j]) in egraph or (list0[j], list0[i]) in egraph:
                if (list0[i], list0[j]) in egraph:
                    score_1 = score_1 + egraph[(list0[i], list0[j])]
                    # evpermissiondic[(list0[i], list0[j])] = egraph[(list0[i], list0[j])]
                    evpermissiondic[k] = {'first':list0[i],'second':list0[j],'score':egraph[(list0[i], list0[j])]}
                else:
                    score_1 = score_1 + egraph[(list0[j], list0[i])]
                    # evpermissiondic[str((list0[j], list0[i]))] = egraph[(list0[j], list0[i])]
                    evpermissiondic[k] = {'first':list0[j],'second':list0[i],'score':egraph[(list0[j], list0[i])]}
                k = k + 1
            if (list0[i], list0[j]) in ngraph or (list0[j], list0[i]) in ngraph:
                if (list0[i], list0[j]) in ngraph:
                    score_2 = score_2 + ngraph[(list0[i], list0[j])]
                else:
                    score_2 = score_2 + ngraph[(list0[j], list0[i])]
    dir0 = {'evil_score': score_1, 'normal_score': score_2}
    evpermissiondic = dict(sorted(evpermissiondic.items(),key=lambda x: x[1]['score'],reverse=True))
    #对字典进行伪切片
    start = 0
    end = 20
    list_per = list(evpermissiondic.keys())[0:20]
    # per_key = list_per[list_per.index(start):list_per.index(end)]
    evpermissiondic = [evpermissiondic[k] for k in list_per]
    if dir0['evil_score'] > dir0['normal_score']:
        ys_no = "Malware!"
    else:
        ys_no = "Normalware!"

    return [ys_no , dir0, evpermissiondic,list0]

